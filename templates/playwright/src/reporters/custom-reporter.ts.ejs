/* eslint-disable @typescript-eslint/no-explicit-any */
import type {
  FullConfig,
  Reporter,
  Suite,
  TestCase,
  TestError,
  TestResult,
} from '@playwright/test/reporter';
import { logger } from '@utils';
import fs from 'fs';
import { bold, cyan, dim, gray, green, magenta, red, yellow } from 'kolorist';
import path from 'path';
import { fileURLToPath } from 'url';

const PROJECT_ROOT = path.resolve(path.dirname(fileURLToPath(import.meta.url)), '../..');
const ARTIFACTS_DIR = path.join(PROJECT_ROOT, 'artifacts');
const REPORT_JSON = path.join(ARTIFACTS_DIR, 'custom-summary.json');

function ensureDir(p: string) {
  fs.mkdirSync(p, { recursive: true });
}

export default class CustomReporter implements Reporter {
  private startedAt = Date.now();
  private projects = new Set<string>();
  private processedKeys = new Set<string>(); // ensure retries counted once per test

  private summary = {
    startedAt: new Date().toISOString(),
    total: 0,
    passed: 0,
    failed: 0, // includes timedOut
    skipped: 0,
    timedOut: 0, // informational
    retriesAttempted: 0,
    durationMs: 0,
    projects: [] as string[],
  };

  private reportMetaData: Record<string, any> = {};

  constructor(options: any = {}) {
    this.reportMetaData = options.reportMetaData || {};
    logger.info('ðŸ“¦ Reporter received metadata:', this.reportMetaData);
  }

  onBegin(config: FullConfig, suite: Suite) {
    ensureDir(ARTIFACTS_DIR);
    logger.info(cyan(`ðŸ§ª Test run started with ${suite.allTests().length} tests`));
  }

  onTestBegin(test: TestCase) {
    this.summary.total++;
    const projectName = test.parent.project()?.name || 'default';
    this.projects.add(projectName);
    logger.info(dim(`â–¶ ${projectName}: ${test.title}`));
  }

  onTestEnd(test: TestCase, result: TestResult) {
    const status = result.status; // 'passed' | 'failed' | 'timedOut' | 'skipped' | 'interrupted'
    const dur = `${result.duration}ms`;
    const title = bold(test.title);

    // ---- retries accounting (only once per test, on its final result) ----
    const isLastEnd = test.results.length > 0 && test.results[test.results.length - 1] === result;
    if (isLastEnd) {
      const key = `${test.location.file}::${test.title}`;
      if (!this.processedKeys.has(key)) {
        const retriesForThisTest = Math.max(0, test.results.length - 1);
        this.summary.retriesAttempted += retriesForThisTest;
        this.processedKeys.add(key);
        if (retriesForThisTest > 0) {
          logger.info(gray(`   âŸ³ retries: ${retriesForThisTest}`));
        }
      }
    }

    // ---- status accounting (treat timedOut as failed in summary) ----
    switch (status) {
      case 'passed':
        this.summary.passed++;
        logger.info(green(`âœ” PASSED â€¢ ${title} (${dur})`));
        break;
      case 'failed':
        this.summary.failed++;
        logger.error(red(`âœ˜ FAILED â€¢ ${title} (${dur})`));
        break;
      case 'timedOut':
        this.summary.timedOut++;
        this.summary.failed++; // count timeouts as failures
        logger.error(magenta(`â± TIMEOUT â€¢ ${title} (${dur})`));
        break;
      case 'skipped':
        this.summary.skipped++;
        logger.warn(yellow(`âš  SKIPPED â€¢ ${title}`));
        break;
      default:
        logger.info(cyan(`â„¹ ${status.toUpperCase()} â€¢ ${title}`));
    }

    if (result.errors?.length) {
      result.errors.forEach((e: TestError) => {
        logger.error(red(`   â†³ ${e.message || e.value || 'Error'}`));
      });
    }
  }

  async onEnd() {
    this.summary.durationMs = Date.now() - this.startedAt;
    this.summary.projects = Array.from(this.projects);

    const out = { ...this.summary, ...this.reportMetaData };
    fs.writeFileSync(REPORT_JSON, JSON.stringify(out, null, 2));

    logger.info(green(`ðŸ“„ Custom summary saved: ${path.relative(PROJECT_ROOT, REPORT_JSON)}`));

    // ---- multiline summary ----
    logger.info(bold(cyan('ðŸ§¾ TEST RUN SUMMARY')));

    logger.info(`${cyan('  Total Tests:')} ${out.total}`);
    logger.info(`${green('  Passed:')} ${out.passed}`);
    logger.info(`${red('  Failed:')} ${out.failed}`);
    if (out.timedOut) logger.info(`${magenta('  Timed Out:')} ${out.timedOut}`);
    logger.info(`${yellow('  Skipped:')} ${out.skipped}`);
    logger.info(`${cyan('  Retries Attempted:')} ${out.retriesAttempted}`);
    logger.info(`${cyan('  Projects:')} ${out.projects.join(', ') || 'default'}`);
    logger.info(`${cyan('  Duration:')} ${out.durationMs} ms`);

    logger.info(bold(cyan('âœ… Test execution complete.\n')));
  }
}
